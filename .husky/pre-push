echo "ğŸ”’ Running security checks before push..."
echo ""

# NPM Audit (HIGH/CRITICAL only in production dependencies)
echo "ğŸ” Running npm audit for HIGH/CRITICAL vulnerabilities..."
npm audit --audit-level=high --production
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ npm audit found HIGH or CRITICAL vulnerabilities in production dependencies!"
  echo ""
  echo "Please run 'npm audit' for details and fix vulnerabilities before pushing."
  echo "To bypass this check (emergency only): git push --no-verify"
  exit 1
fi
echo "âœ… No HIGH/CRITICAL vulnerabilities found"
echo ""

# Secret scan with gitleaks (if installed)
if command -v gitleaks &> /dev/null; then
  echo "ğŸ” Scanning for secrets with gitleaks..."
  gitleaks protect --staged --verbose --no-banner
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Potential secrets detected in your code!"
    echo ""
    echo "Please remove secrets before pushing."
    echo "To bypass this check (emergency only): git push --no-verify"
    exit 1
  fi
  echo "âœ… No secrets detected"
  echo ""
else
  echo "â„¹ï¸  gitleaks not installed - skipping secret scan"
  echo "   Install with: brew install gitleaks"
  echo ""
fi

echo "ğŸ§ª Running P0 critical tests before push..."
echo ""
echo "âš ï¸  This may take 1-2 minutes. You can skip with --no-verify if needed."
echo ""

# Run P0 critical tests only (faster than full suite)
npm run test:p0
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ P0 critical tests failed!"
  echo ""
  echo "Please fix failing tests before pushing to remote."
  echo "To bypass this check (emergency only): git push --no-verify"
  exit 1
fi

echo ""
echo "âœ… All P0 critical tests passed!"
echo "ğŸš€ Proceeding with push..."
