echo "ğŸ”’ Running security checks before push..."
echo ""

# NPM Audit (HIGH/CRITICAL only in production dependencies)
echo "ğŸ” Running npm audit for HIGH/CRITICAL vulnerabilities..."
npm audit --audit-level=high --production
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ npm audit found HIGH or CRITICAL vulnerabilities in production dependencies!"
  echo ""
  echo "Please run 'npm audit' for details and fix vulnerabilities before pushing."
  echo "To bypass this check (emergency only): git push --no-verify"
  exit 1
fi
echo "âœ… No HIGH/CRITICAL vulnerabilities found"
echo ""

# Secret scan with gitleaks (if installed)
if command -v gitleaks &> /dev/null; then
  echo "ğŸ” Scanning for secrets with gitleaks..."
  gitleaks protect --staged --verbose --no-banner
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Potential secrets detected in your code!"
    echo ""
    echo "Please remove secrets before pushing."
    echo "To bypass this check (emergency only): git push --no-verify"
    exit 1
  fi
  echo "âœ… No secrets detected"
  echo ""
else
  echo "â„¹ï¸  gitleaks not installed - skipping secret scan"
  echo "   Install with: brew install gitleaks"
  echo ""
fi

# Tests are handled by CI/CD pipeline
# If you want to run tests locally before push:
#   npm run test:canary (fast golden-path tests)
#   npm run test:p0 (full P0 suite - slow!)

echo "âœ… Pre-push checks passed!"
echo "ğŸš€ Proceeding with push..."
echo ""
echo "â„¹ï¸  Tests will run in CI/CD pipeline"
echo "   To run locally: npm run test:canary"
