name: Nightly Full Test Suite

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  full-test-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      matrix:
        node-version: [18.x]
        browser: [chromium, mobile-chrome, mobile-safari]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          # Start PostgreSQL service
          sudo systemctl start postgresql.service

          # Create test database and user
          sudo -u postgres psql -c "CREATE USER test_user WITH PASSWORD 'test_password';"
          sudo -u postgres psql -c "CREATE DATABASE test_db OWNER test_user;"

          # Run migrations
          npx prisma migrate deploy

      - name: Run Full Test Suite
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          JWT_SECRET: test-jwt-secret-for-ci-only-min-32-characters-long
          RESEND_API_KEY: re_test_key
          EMAIL_FROM: test@example.com
          NEXT_PUBLIC_BASE_URL: http://localhost:9000
        run: |
          # Start dev server in background
          npm run dev &

          # Wait for server to be ready
          npx wait-on http://localhost:9000/api/health --timeout 60000

          # Run all tests with specific browser
          if [ "${{ matrix.browser }}" = "chromium" ]; then
            npx playwright test --project=chromium --reporter=html,json
          elif [ "${{ matrix.browser }}" = "mobile-chrome" ]; then
            npx playwright test --project='Mobile Chrome' --reporter=html,json
          elif [ "${{ matrix.browser }}" = "mobile-safari" ]; then
            npx playwright test --project='Mobile Safari' --reporter=html,json
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}-${{ matrix.node-version }}
          path: |
            playwright-report/
            test-results/
            test-results.json
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          echo "## Nightly Test Results - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            # Parse test results (basic parsing, can be enhanced)
            echo "Test execution completed. Check artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure (placeholder)
        if: failure()
        run: |
          echo "ðŸš¨ Nightly tests failed for ${{ matrix.browser }}"
          echo "TODO: Implement Slack/Email notification here"
          echo "Notification details:"
          echo "- Browser: ${{ matrix.browser }}"
          echo "- Node version: ${{ matrix.node-version }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  aggregate-results:
    needs: full-test-suite
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/

      - name: Generate combined report
        run: |
          echo "# Nightly Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count test result files
          total_browsers=$(find all-test-results -name "test-results-*" -type d | wc -l)
          echo "**Browsers Tested:** $total_browsers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Coverage by Browser" >> $GITHUB_STEP_SUMMARY
          for dir in all-test-results/test-results-*; do
            if [ -d "$dir" ]; then
              browser=$(basename "$dir" | sed 's/test-results-//')
              echo "- **$browser**: Tests completed" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in [Actions artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-summary
          path: all-test-results/
          retention-days: 30

      - name: Send notification (placeholder)
        run: |
          echo "ðŸ“§ TODO: Send summary email/Slack notification"
          echo "Summary generated at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
